import{a as te,b as se}from"/build/_shared/chunk-RHTBOEYQ.js";import{a as ee}from"/build/_shared/chunk-HNF2M344.js";import{a as xe,b as Pe}from"/build/_shared/chunk-IQV4D3C7.js";import{a as Ce}from"/build/_shared/chunk-H33OI7YH.js";import{a as Ne}from"/build/_shared/chunk-JBQJJPFB.js";import{a as Y}from"/build/_shared/chunk-M3TRH43M.js";import{a as ge}from"/build/_shared/chunk-WZRQ3RQI.js";import{a as he,d as be,e as ye,g as we}from"/build/_shared/chunk-KLKNQD3Q.js";import{a as $,b as de,c as me,e as O}from"/build/_shared/chunk-G5A27C7O.js";import{a as h,h as p}from"/build/_shared/chunk-NVGVVEPD.js";import{Ia as G,N as q,O as Z,Ra as ve,ja as _,na as X,ra as fe,u as ue,v as pe}from"/build/_shared/chunk-PNJDYZ5P.js";import{d as ne,h as ce,r as z}from"/build/_shared/chunk-GTSSQFHM.js";import{a as Q,b as T}from"/build/_shared/chunk-BBTKOQ57.js";import{e as x}from"/build/_shared/chunk-UED2Q7CE.js";var g=x(Q());var U=x(Q());var r=x(T());function Ie({onSelect:i,multiple:E=!1}){let[n,D]=(0,U.useState)(""),[d,k]=(0,U.useState)([]),[u,j]=(0,U.useState)({docId:null,isPlaying:!1}),P=(0,U.useRef)({}),m=z(),[f,R]=(0,U.useState)(1),[B,A]=ce(),V=ne();(0,U.useEffect)(()=>{m.load(`/api/media?filter=${n}&page=${f}`)},[n,f]);let v=m.data?.documents||[],b=m.state==="loading",C=s=>{k(E?c=>c.some(N=>N.id===s.id)?c.filter(N=>N.id!==s.id):[...c,s]:[s])},L=(s,c)=>{s.stopPropagation();let N=P.current[c];N&&(u.docId===c&&u.isPlaying?(N.pause(),j({docId:null,isPlaying:!1})):(u.docId&&u.docId!==c&&P.current[u.docId]?.pause(),N.play().catch(console.error),j({docId:c,isPlaying:!0})))},I=()=>{i(d)},J=s=>{let{mimeType:c,extension:N}=s.file.meta;return c.startsWith("image/")?(0,r.jsx)("img",{src:s.file.url,alt:s.label,className:"w-full h-full object-cover"}):c.startsWith("video/")?(0,r.jsxs)("div",{className:"relative w-full h-full",children:[(0,r.jsx)("video",{ref:F=>F&&(P.current[s.id]=F),className:"w-full h-full object-cover",src:s.file.url,muted:!0,playsInline:!0,onEnded:()=>j({docId:null,isPlaying:!1}),children:(0,r.jsx)("track",{kind:"captions",src:`/captions/${s.id}.vtt`,srcLang:"fr",label:"Fran\xE7ais",default:!0})}),(0,r.jsxs)(p,{type:"button",variant:"secondary",size:"icon",className:h("absolute inset-0 m-auto","w-10 h-10 rounded-full","bg-background/80 hover:bg-background/90","transition-all duration-200",u.docId===s.id&&u.isPlaying?"opacity-0 hover:opacity-100":"opacity-100"),onClick:F=>L(F,s.id),children:[u.docId===s.id&&u.isPlaying?(0,r.jsx)(_,{className:"h-4 w-4"}):(0,r.jsx)(X,{className:"h-4 w-4"}),(0,r.jsx)("span",{className:"sr-only",children:u.docId===s.id&&u.isPlaying?"Pause":"Lecture"})]})]}):(0,r.jsxs)("div",{className:"flex flex-col items-center justify-center",children:[(0,r.jsx)(q,{className:"w-12 h-12 text-muted-foreground"}),(0,r.jsx)("span",{className:"mt-2 text-xs text-muted-foreground uppercase",children:N||"Fichier"})]})};return(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)(fe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground"}),(0,r.jsx)(ge,{type:"text",placeholder:"Rechercher des fichiers...",value:n,onChange:s=>D(s.target.value),className:"pl-10"})]}),(0,r.jsx)("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 max-h-[60vh] overflow-y-auto p-1",children:b?Array.from({length:8}).map((s,c)=>(0,r.jsx)($,{className:"cursor-pointer hover:shadow-md transition-shadow",children:(0,r.jsxs)(O,{className:"p-4",children:[(0,r.jsx)(Y,{className:"aspect-square w-full mb-2"}),(0,r.jsx)(Y,{className:"h-4 w-3/4"})]})},`skeleton-${c}`)):v.totalResults<1?(0,r.jsx)("div",{className:"flex items-center justify-center h-96",children:(0,r.jsx)("p",{className:"text-xl text-gray-500",children:"Aucun fichier trouv\xE9. Veuillez utiliser le media manager pour t\xE9l\xE9charger des fichiers."})}):(0,r.jsx)(r.Fragment,{children:v?.results?.map(s=>(0,r.jsx)($,{className:h("cursor-pointer hover:shadow-md transition-all duration-200","border-2",d.some(c=>c.id===s.id)?"border-primary":"border-transparent hover:border-primary/50"),onClick:()=>C(s),children:(0,r.jsxs)(O,{className:"p-4",children:[(0,r.jsx)("div",{className:h("aspect-square mb-2","bg-muted rounded-md","overflow-hidden"),children:J(s)}),(0,r.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,r.jsx)("p",{className:"text-sm font-medium truncate flex-1",title:s.label,children:s.label||"Sans titre"}),(0,r.jsx)(Ne,{checked:d.some(c=>c.id===s.id),className:"translate-y-[1px]"})]})]})},s.id))})}),!b&&v.totalResults>0&&(0,r.jsxs)("div",{className:"mt-8 flex flex-col sm:flex-row justify-center items-center gap-4 mb-2",children:[(0,r.jsx)(p,{variant:"outline",onClick:()=>{R(v.page-1)},disabled:v.page===1,className:"w-full sm:w-auto h-12 text-base",children:(0,r.jsx)(ue,{className:"h-5 w-5"})}),(0,r.jsxs)("span",{className:"text-base",children:["Page ",v.page," / ",v.totalResults," media(s)"]}),(0,r.jsx)(p,{variant:"outline",onClick:()=>{R(v.page+1)},disabled:v.page===v.totalPages,className:"w-full sm:w-auto h-12 text-base",children:(0,r.jsx)(pe,{className:"h-5 w-5"})})]}),(0,r.jsx)(p,{onClick:I,disabled:d.length===0,className:"w-full",children:E?"S\xE9lectionner des fichiers":"S\xE9lectionner un fichier"})]})}var W=x(Q());var l=x(T());function De({document:i,onRemove:E,disabled:n=!1,showRemoveButton:D=!0}){let[d,k]=(0,W.useState)(!1),[u,j]=(0,W.useState)(!1),[P,m]=(0,W.useState)(null),f=(0,W.useRef)(null),R=i.file.meta.mimeType.startsWith("image/"),B=i.file.meta.mimeType.startsWith("video/"),A=b=>{b.preventDefault(),b.stopPropagation(),f.current&&(d?f.current.pause():f.current.play().catch(C=>{m("Erreur de lecture de la vid\xE9o"),console.error(C)}),k(!d))},V=()=>{j(!0),m(null)},v=()=>{j(!1),m("Impossible de charger la vid\xE9o")};return(0,l.jsx)($,{className:h("overflow-hidden","transition-all duration-200","hover:shadow-md",n&&"opacity-50"),children:(0,l.jsxs)(O,{className:"p-3",children:[(0,l.jsx)("div",{className:h("relative aspect-square mb-3","bg-muted rounded-md","flex items-center justify-center","overflow-hidden"),children:R?(0,l.jsx)("img",{src:i.file.url,alt:i.label||"Image",className:h("w-full h-full","object-cover","transition-transform duration-200","hover:scale-105")}):B?(0,l.jsxs)("div",{className:"relative w-full h-full",children:[(0,l.jsxs)("video",{ref:f,className:"w-full h-full object-cover",onLoadedData:V,onError:v,playsInline:!0,muted:!0,children:[(0,l.jsx)("source",{src:i.file.url,type:i.file.meta.mimeType}),(0,l.jsx)("track",{kind:"captions",src:`/captions/${i.id}.vtt`,srcLang:"fr",label:"Fran\xE7ais",default:!0}),"Votre navigateur ne prend pas en charge la lecture de vid\xE9os."]}),!u&&!P&&(0,l.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-muted",children:(0,l.jsx)(q,{className:"h-12 w-12 text-muted-foreground"})}),P?(0,l.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-muted",children:(0,l.jsx)("p",{className:"text-sm text-destructive px-2 text-center",children:P})}):u&&(0,l.jsxs)(p,{variant:"secondary",size:"icon",className:h("absolute inset-0 m-auto","w-12 h-12 rounded-full","bg-background/80 hover:bg-background/90","transition-opacity duration-200",!d&&"opacity-0 hover:opacity-100"),onClick:b=>A(b),disabled:n,children:[d?(0,l.jsx)(_,{className:"h-6 w-6"}):(0,l.jsx)(X,{className:"h-6 w-6"}),(0,l.jsx)("span",{className:"sr-only",children:d?"Pause":"Lecture"})]})]}):(0,l.jsxs)("div",{className:"flex flex-col items-center justify-center p-4",children:[(0,l.jsx)(q,{className:"h-12 w-12 text-muted-foreground mb-2"}),(0,l.jsx)("span",{className:"text-xs text-muted-foreground uppercase",children:i.file.meta.extension})]})}),(0,l.jsxs)("div",{className:"space-y-3",children:[(0,l.jsx)("p",{className:h("text-sm font-medium truncate","text-foreground/90"),title:i.label,children:i.label||""}),D&&(0,l.jsxs)(p,{type:"button",variant:"destructive",size:"sm",onClick:E,className:"w-full",disabled:n,children:[(0,l.jsx)(ve,{className:"h-4 w-4 mr-2"}),"Supprimer"]})]})]})})}var w=x(T());function ke({previewUrl:i,onUploadClick:E,onExplorerClick:n,isBusy:D}){return(0,w.jsxs)("div",{className:"relative w-32 h-32 mx-auto mb-4",children:[(0,w.jsx)("div",{className:h("w-full h-full rounded-full border-2 border-dashed border-gray-300 overflow-hidden","flex items-center justify-center bg-muted",i?"border-none":""),children:i?(0,w.jsx)("img",{src:i||"/placeholder.svg",alt:"Avatar preview",className:"w-full h-full object-cover"}):(0,w.jsx)("div",{className:"p-2",children:(0,w.jsx)("span",{className:"text-sm text-center text-muted-foreground",children:"Aucune image"})})}),(0,w.jsxs)("div",{className:"absolute -bottom-2 left-1/2 -translate-x-1/2 flex gap-2",children:[(0,w.jsx)(p,{type:"button",size:"sm",variant:"secondary",onClick:E,disabled:D,children:(0,w.jsx)(G,{className:"h-4 w-4"})}),(0,w.jsx)(p,{type:"button",size:"sm",variant:"secondary",onClick:n,disabled:D,children:(0,w.jsx)(Z,{className:"h-4 w-4"})})]})]})}var t=x(T());function pt({onSelect:i,onBusyStateChange:E,multiple:n=!1,accept:D,maxSize:d,defaultSelectedDocuments:k=[],className:u="",can:j,isAvatar:P=!1}){let[m,f]=(0,g.useState)([]),[R,B]=(0,g.useState)(k),[A,V]=(0,g.useState)(!1),[v,b]=(0,g.useState)(!1),[C,L]=(0,g.useState)({}),[I,J]=(0,g.useState)(!1),s=z(),c=(0,g.useRef)(null),{toast:N}=Ce(),[F,H]=(0,g.useState)(null),Be=z();(0,g.useEffect)(()=>{let e=s.state!=="idle",a=Object.values(C).some(y=>y<100),o=e||a||A;J(o),E?.(o)},[s.state,C,A]),(0,g.useEffect)(()=>{k.length>0&&(B(k),i(k))},[]),(0,g.useEffect)(()=>{if(s.data&&s.data.success){let e=s.data.documents;B(a=>{let o=n?[...a,...e]:e;return i(o),o}),f([]),L({})}else s.data&&s.data.error&&(H(s.data.error),N({title:"Erreur",description:`Erreur lors du t\xE9l\xE9chargement: ${s.data.error}`,variant:"destructive"}),Ue())},[s.data,n]);let re=e=>{if(P){if(Array.from(e).filter(S=>d&&S.size>d).length>0){H(`L'image d\xE9passe la taille maximale autoris\xE9e de ${d/1024/1024} MB.`);return}let M=Array.from(e).filter(S=>S.type.startsWith("image/")).slice(0,1).map(S=>({file:S,progress:0,previewUrl:URL.createObjectURL(S)}));if(M.length===0){H("Veuillez s\xE9lectionner une image valide");return}f(M),K(M);return}if(Array.from(e).filter(y=>d&&y.size>d).length>0){H(`Un ou plusieurs fichiers d\xE9passent la taille maximale autoris\xE9e de ${d/1024/1024} MB.`);return}let o=Array.from(e).map(y=>({file:y,progress:0,previewUrl:y.type.startsWith("image/")?URL.createObjectURL(y):void 0}));n?(f(y=>[...y,...o]),K(o)):(f(o.slice(0,1)),K(o.slice(0,1)))},ae=()=>{H(null),b(!0),f([]),L({})},oe=e=>{f(a=>{let o=[...a];return o[e].previewUrl&&URL.revokeObjectURL(o[e].previewUrl),o.splice(e,1),o}),L(a=>{let o={...a};return delete o[e],o})},Fe=e=>{B(a=>{let o=[...a];return o.splice(e,1),i(o),o})},K=e=>{let a=new FormData;a.append("_action","upload"),e.forEach(o=>{a.append("files",o.file)}),s.submit(a,{method:"post",action:"/api/media",encType:"multipart/form-data"}),e.forEach((o,y)=>{let M=0,S=setInterval(()=>{M+=Math.random()*10,M>90&&(clearInterval(S),M=100),L(Re=>({...Re,[y]:Math.round(M)}))},200)})};(0,g.useEffect)(()=>{s.state==="idle"&&L(e=>{let a={...e};return Object.keys(a).forEach(o=>{a[o]=100}),a})},[s.state]);let Ue=()=>{c.current&&(c.current.reset(),f([]),L({}))},Ee=e=>{if(n)B(a=>{let o=[...a,...e];return i(o),o});else{let a=e.slice(-1);B(a),i(a)}V(!1),b(!1)},le=e=>{e.preventDefault(),V(!0),b(!1)},ie=()=>{b(e=>!e),A&&V(!1)};return(0,t.jsxs)(xe,{children:[P?(0,t.jsxs)("div",{className:"mb-8",children:[(0,t.jsx)(ke,{previewUrl:R[0]?.file?.url||m[0]?.previewUrl,onUploadClick:ie,onExplorerClick:le,isBusy:I}),v&&(0,t.jsx)(t.Fragment,{children:F?(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("p",{className:"text-red-500 font-medium mb-4",children:F}),(0,t.jsx)(p,{onClick:ae,children:"Ressayer"})]}):(0,t.jsxs)("form",{ref:c,className:"space-y-4",onSubmit:e=>e.preventDefault(),children:[(0,t.jsx)(se,{maxSize:d?`${d/1024/1024}MB`:"5MB",multiple:n,accept:D,onFileSelect:re,maxFilesNumber:n?void 0:1,disabled:I}),m.length>0&&(0,t.jsx)("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:m.map((e,a)=>(0,t.jsx)(te,{file:e.file,progress:C[a]||0,previewUrl:e.previewUrl,onRemove:()=>oe(a),disabled:I},`${e.file.name}-${a}`))}),s.state!=="idle"&&m.length>0&&(0,t.jsx)(ee,{value:Object.values(C).reduce((e,a)=>e+a,0)/m.length,className:"w-full"})]})})]}):(0,t.jsxs)($,{className:h("mb-8 val-card-media-zone",u),children:[(0,t.jsx)(de,{children:(0,t.jsxs)(me,{className:"text-center text-base sm:text-lg md:text-xl",children:["Choisissez une m\xE9thode pour s\xE9lectionner",n?" des fichiers":" un fichier"]})}),(0,t.jsxs)(O,{children:[(0,t.jsxs)("div",{className:"flex flex-col sm:flex-row gap-4 mb-4 text-center justify-center items-center",children:[(0,t.jsxs)(p,{type:"button",onClick:ie,className:"w-full sm:w-auto",disabled:I,children:[(0,t.jsx)(G,{className:"mr-2 h-4 w-4"}),"T\xE9l\xE9verser ",n?" des fichiers":" un fichier"]}),(0,t.jsxs)(p,{type:"button",onClick:le,className:"w-full sm:w-auto",disabled:I,children:[(0,t.jsx)(Z,{className:"mr-2 h-4 w-4"}),"Choisir depuis la m\xE9diath\xE8que"]})]}),v&&(0,t.jsx)(t.Fragment,{children:F?(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)("p",{className:"text-red-500 font-medium mb-4",children:F}),(0,t.jsx)(p,{onClick:ae,children:"Ressayer"})]}):(0,t.jsxs)("form",{ref:c,className:"space-y-4",onSubmit:e=>e.preventDefault(),children:[(0,t.jsx)(se,{maxSize:d?`${d/1024/1024}MB`:"5MB",multiple:n,accept:D,onFileSelect:re,maxFilesNumber:n?void 0:1,disabled:I}),m.length>0&&(0,t.jsx)("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:m.map((e,a)=>(0,t.jsx)(te,{file:e.file,progress:C[a]||0,previewUrl:e.previewUrl,onRemove:()=>oe(a),disabled:I},`${e.file.name}-${a}`))}),s.state!=="idle"&&m.length>0&&(0,t.jsx)(ee,{value:Object.values(C).reduce((e,a)=>e+a,0)/m.length,className:"w-full"})]})}),R.length>0&&(0,t.jsxs)("div",{className:"mt-4",children:[(0,t.jsx)("h6",{className:"text-sm font-medium mb-2",children:"S\xE9lections depuis le M\xE9dia Manager"}),(0,t.jsx)("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:R.map((e,a)=>(0,t.jsx)(De,{document:e,onRemove:()=>Fe(a),disabled:I,showRemoveButton:!0},e.id))})]})]})]}),(0,t.jsx)(he,{open:A,onOpenChange:V,children:(0,t.jsxs)(be,{className:"max-w-3xl",children:[(0,t.jsx)(ye,{children:(0,t.jsxs)(we,{children:["S\xE9lectionner ",n?"des fichiers":"un fichier"]})}),(0,t.jsx)(Ie,{onSelect:Ee,multiple:n})]})}),(0,t.jsx)(Pe,{})]})}export{pt as a};
